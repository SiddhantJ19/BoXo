{% load static %}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>Chat Room</title>
    <script src="{% static 'JS/spark-md5.js' %}" type="text/javascript"></script>
</head>
<body>
    <textarea id="chat-log" cols="100" rows="20"></textarea><br/>
    <!-- <input id="chat-message-input" type="text" size="100"/><br/> -->
    <!-- <input id="chat-message-submit" type="button" value="Send"/> -->
        <div class="actions">
            <input type="file" id="file" class="input-file span5"/>
            <input type="button" id="normal" value="Normal" class="btn primary" onclick="send" />
            <input type="button" id="clear" value="Clear" class="btn"/>
        </div>
        <div id="log"></div>

</body>

<script>

    

    var messagesend = "Waitt";

        var blobSlice = File.prototype.slice || File.prototype.mozSlice || File.prototype.webkitSlice,
                log = document.getElementById('log'),
                input = document.getElementById('file'),
                running = false,
                ua = navigator.userAgent.toLowerCase();

            function registerLog(str, className) {
                var elem = document.createElement('div');

                elem.innerHTML = str;
                elem.className = 'alert-message' + (className ? ' '  + className : '');
                log.appendChild(elem);
            }

             function doNormalTest() {
                if (running) {
                    return;
                }

                if (!input.files.length) {
                    registerLog('<strong>Please select a file.</strong><br/>');
                    return;
                }

                var fileReader = new FileReader(),
                    file = input.files[0],
                    time;

                fileReader.onload =  function (e) {
                    running = false;

                    if (file.size != e.target.result.byteLength) {
                        registerLog('<strong>ERROR:</strong> Browser reported success but could not read the file until the end.<br/>', 'error');
                    } else {
                        registerLog('<strong>Finished loading!</strong><br/>', 'success');
                        registerLog('<strong>Computed hash:</strong> ' + SparkMD5.ArrayBuffer.hash(e.target.result) + '<br/>', 'success'); // compute hash
                           messagesend = SparkMD5.ArrayBuffer.hash(e.target.result);
                        
                        console.log(messagesend);
                        console.log("zzzzzzzzzzzz");

                        registerLog('<strong>Total time:</strong> ' + (new Date().getTime() - time) + 'ms<br/>', 'success');
                    }
                };

                fileReader.onerror = function () {
                    running = false;
                    registerLog('<strong>ERROR:</strong> FileReader onerror was triggered, maybe the browser aborted due to high memory usage.<br/>', 'error');
                };

                running = true;
                registerLog('<strong>Starting normal test (' + file.name + ')</strong><br/>', 'info');
                time = new Date().getTime();
                fileReader.readAsArrayBuffer(file);
            }

            function clearLog() {
                if (!running) {
                    log.innerHTML = '';
                }
            }

            if (!('FileReader' in window) || !('File' in window) || !blobSlice) {
                registerLog('<p><strong>Your browser does not support the FileAPI or slicing of files.</strong></p>', 'error');
            } else {
                registerLog('Keep your devtools closed otherwise this example will be a LOT slower', 'info');

                console.log("1");
                document.getElementById('normal').addEventListener('click', doNormalTest);
                console.log("2");
                document.getElementById('clear').addEventListener('click', clearLog);
            }

    
var roomName = {{ room_name_json }};
    
    console.log("asdadadad");
    console.log("4654654"+messagesend);

    console.log("3");
    var chatSocket = new WebSocket(
        'ws://' + window.location.host +
        '/ws/chat/' + roomName + '/');
    console.log('data');
    console.log("4");
    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        console.log(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message + '\n');
    };

    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };

    console.log("5");
    document.querySelector('#normal').onclick = function(e) {
        // var messageInputDom = document.querySelector('#chat-message-input');
        // var message = messageInputDom.value;
        document.getElementById('normal').addEventListener('click', doNormalTest);

        chatSocket.send(JSON.stringify({
            'message': messagesend
        }));
        console.log("6");
        messageInputDom.value = '';
    };

</script>
</html>
